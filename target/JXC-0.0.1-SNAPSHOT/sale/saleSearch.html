<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="Thymeleaf"
	  xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
<meta charset="UTF-8">
<title>销售单据查询</title>
<link rel="stylesheet" type="text/css" href="/static/jquery-easyui-1.3.3/themes/default/easyui.css"></link>
<link rel="stylesheet" type="text/css" href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
<style type="text/css">
	.frm-container {
		margin-bottom: 5px;
		clear: both;
		overflow: hidden;
		text-align: center;
	}

	.frm-field {
		float:left;
		margin-bottom: 1px;
		width: 300px;
		margin-right: 10px;
	}

	.frm-label {
		float:left;
		margin-bottom: 1px;
		width: 100px;
	}

	.frm-control {
		float: left;
		margin-bottom: 1px;
		width: 160px;
	}

	.frm-control input {
		width: 178px;
	}

</style>
<script type="text/javascript" src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
<script type="text/javascript" src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
<script type="text/javascript" src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>

<script type="text/javascript" src="/static/js/date.js"></script>
<script type="text/javascript">
	
	
	function formatUser(val,row){
		return val.trueName+"&nbsp;("+val.userName+")&nbsp;";
	}
	
	
	function searchSale(){
		$("#dg2").datagrid("loadData",{total:0,rows:[]});
		var customerId;
		if(isNaN($("#s_customer").combobox("getValue"))){
			customerId="";
		}else{
			customerId=$("#s_customer").combobox("getValue");
		}
		$("#dg").datagrid({
			queryParams:{
				saleNumber:$("#s_saleNumber").val(),
				"customer.id":customerId,
				state:$("#s_state").combobox("getValue"),
				bSaleDate:$("#s_bSaleDate").datebox("getValue"),
				eSaleDate:$("#s_eSaleDate").datebox("getValue")
			}
		});
	}
	
	function formatSupplier(val,row){
		return val.name;
	}

	function formatShopName(val, row) {
		return val.name + "-" +  val.name2;
    }
	
	function formatAmountPayable(val,row){
	    if (val) {
            return "¥"+val.toFixed(2);
		} else {
	        return "¥0.00"
		}
	}
	
	function formatUser(val,row){
		return val.trueName;
	}
	
	function deleteSale(){
		var selectedRows=$("#dg").datagrid("getSelections");
		if(selectedRows.length!=1){
			$.messager.alert("系统提示","请选择一条要删除的销售单！");
			return;
		}
		var id=selectedRows[0].id;
		$.messager.confirm("系统提示","<font color=red>删除销售单后将无法恢复，是否删除?</font>",function(r){
			if(r){
				$.post("/admin/saleList/delete",{id:id},function(result){
					if(result.success){
						$("#dg").datagrid("reload");
						$("#dg2").datagrid("reload");
					}else{
						$.messager.alert("系统提示",result.errorInfo);
					}
				},"json");
			}
		});
	}
	
	
	$(document).ready(function() {
		
		$("#s_bSaleDate").datebox("setValue",genLastMonthDayStr()); // 设置上个月日期
		$("#s_eSaleDate").datebox("setValue",genTodayStr()); // 设置当前日期
		
		$("#dg").datagrid({
			onClickRow:function(index,row){
				$("#dg2").datagrid({
					url:'/admin/saleList/listGoods',
					queryParams:{
						saleListId:row.id
					}
				});
			}
		});

		$.each($("span[hasRole]"), function() {
			var role = $(this).attr('hasRole');
			var self = $(this);

			$.get('/user/hasRole', {name: role}, function(data) {
			    if (!data.hasRole) {
                    self.empty();
				}

			}, 'json');
		});
		
	});

	function modifyAmount() {
        var selectedRows=$("#dg").datagrid("getSelections");
        if(selectedRows.length!=1){
            $.messager.alert("系统提示","请选择一条要修改尾款的销售单！");
            return;
        }

        $("#dlg").dialog("open").dialog("setTitle","销售金额更新");
        $("input[name=saleId]").val(selectedRows[0].id);
    }

	function saveUserAmount() {
        $("#fm").form("submit",{
            url:"/admin/saleList/updateAmount",
            onSubmit:function(){
                if(!$(this).form("validate")){
                    return false;
                }
                return true;
            },
            success:function(result){
                var result=eval('('+result+')');
                if(result.success){
                    alert("保存成功！");
                    window.location.reload();
                }else{
                    $.messager.alert("系统提示",result.errorInfo);
                }
            }
        });
    }

	function closeUserAmountDialog() {
        $("#dlg").dialog("close");
	}
	
	
	function formatPrice(val,row){
        if (val) {
            return "¥"+val.toFixed(2);
        }
	}

	function formatTotal(val,row){
	    if (val) {
            return "¥"+val.toFixed(2);
		}
	}

	function formatAddress(val, row) {
	    return val.address;
	}

	function formatContact(val, row) {
	    return val.contact;
	}

	function formatRate(val, row) {
        if (val) {
            return val.toFixed(2) + "%";
        }
	}

	function formatTrueName(val, row) {
	    if (val) {
	        return val.trueName;
		}
	}

	function exportSale() {
        var exportUrl = '/admin/saleList/export';

        var customerId;
        if(isNaN($("#s_customer").combobox("getValue"))){
            customerId="";
        }else{
            customerId=$("#s_customer").combobox("getValue");
        }

        var searchObj = {
            saleNumber:$("#s_saleNumber").val(),
            "customer.id":customerId,
            state:$("#s_state").combobox("getValue"),
            bSaleDate:$("#s_bSaleDate").datebox("getValue"),
            eSaleDate:$("#s_eSaleDate").datebox("getValue")
        };

        var form = $('<form method="POST" action="' + exportUrl + '">');
        $.each(searchObj, function(k, v) {
            form.append($('<input type="hidden" name="' + k +
                '" value="' + v + '">'));
        });

        $('body').append(form);
        form.submit();

        form.remove();
    }
</script>
</head>
<body class="easyui-layout" style="margin: 1px">
 <div region="north" style="height: 350px">
	<table id="dg" title="销售单据查询" class="easyui-datagrid"
	fitColumns="false" pagination="true" rownumbers="true" singleSelect="true"
	fit="true" toolbar="#tb" url="/admin/saleList/list">
		<thead>
			<th field="id" width="20" align="center" hidden="true">销售单ID</th>
			<th field="saleDate" width="80" align="center">销售日期</th>
			<th field="shop" width="80" align="center" formatter="formatShopName">门店</th>
			<th field="customer" width="100" align="center" formatter="formatSupplier">客户</th>
			<th field="customer" width="100" align="center" formatter="formatAddress">地址</th>
			<th field="customer" width="100" align="center" formatter="formatContact">电话</th>

			<th field="contractNumber" width="80" align="center">合同编号</th>
			<th field="amountPayable" width="80" align="right" formatter="formatAmountPayable">统一零售价</th>
			<th field="amountPaid" width="60" align="right" formatter="formatAmountPayable">实收全款</th>
			<th field="amountDiscount" width="60" align="right" formatter="formatAmountPayable">优惠金额</th>
			<th field="amountEarnest" width="60" align="right" formatter="formatAmountPayable">实收定金</th>
			<th field="amountFinalPayment" width="60" align="right" formatter="formatAmountPayable">待收余额</th>
            <th field="amountBalance" width="60" align="right" formatter="formatAmountPayable">已付金额</th>
			<th field="grossProfit" width="60" align="right" formatter="formatAmountPayable">毛利</th>
			<th field="grossProfitRate" width="60" align="right" formatter="formatRate">毛利率</th>
			<th field="card" width="100" align="center" formatter="formatSupplier">款项去向</th>
			<th field="saleListPerson" width="150" align="center">销售员</th>
			<th field="factoryDate" width="80" align="center">工厂下单时间</th>
			<th field="deliveryDate" width="80" align="center">送货日期</th>
			<th field="matchmaker" width="80" align="center">媒人</th>
			<th field="user" width="80" align="center" formatter="formatTrueName">制单人</th>
		</thead>
	</table>
	
	<div id="tb">
		<fieldset style="border-color: #E7F0FF">
			<legend>查询设置</legend>
			&nbsp;单据号&nbsp;
			<input type="text" id="s_saleNumber" size="15" onkeydown="if(event.keyCode==13) searchSale()"/>
			&nbsp;&nbsp;&nbsp;客户：&nbsp;<input class="easyui-combobox" id="s_customer" name="customer.id" style="width: 200px" required="true" data-options="required:true,panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/customer/comboList'"/>
			&nbsp;&nbsp;&nbsp;是否付款&nbsp;
			<select class="easyui-combobox" id="s_state" style="width: 100px" editable="false" panelHeight="auto">
				<option value="">全部</option>
				<option value="1">已付</option>
				<option value="2">未付</option>
			</select>
			&nbsp;&nbsp;&nbsp;日期：&nbsp;
			<input id="s_bSaleDate" class="easyui-datebox" editable=false style="width:100px"/>
			&nbsp;&nbsp;-&nbsp;&nbsp;
			<input id="s_eSaleDate" class="easyui-datebox" editable=false style="width:100px"/>
			&nbsp;&nbsp;<a href="javascript:searchSale()" class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
			<span hasRole="roleKey2">
				&nbsp;&nbsp;<a href="javascript:deleteSale()" class="easyui-linkbutton" iconCls="icon-remove" plain="true">删除</a>
				&nbsp;&nbsp;<a href="javascript:modifyAmount()" class="easyui-linkbutton" iconCls="icon-save" plain="true">收尾款</a>
				&nbsp;&nbsp;<a href="javascript:exportSale()" class="easyui-linkbutton" iconCls="icon-save" plain="true">导出</a>
			</span>
		</fieldset>
	</div>
 </div>
 <div region="center" style="margin-top: 5px">
     <table id="dg2"  class="easyui-datagrid"
		fitColumns="true"  rownumbers="true" singleSelect="true"
		 fit="true" >
			<thead>
				<th field="model" width="50" align="center">商品型号</th>
				<th field="size" width="50" align="center">尺寸</th>
				<th field="num" width="50" align="center">数量</th>
				<th field="price" width="50" align="right" formatter="formatPrice">单价</th>
				<th field="total" width="50" align="right" formatter="formatTotal">总金额</th>
			</thead>
	</table>
 </div>

 <div id="dlg" class="easyui-dialog" style="width: 400px;height: 220px;padding: 20px"
	  closed="true" buttons="#dlg-buttons" >

	 <fieldset style="border-color: #E7F0FF">
		 <legend>销售金额</legend>
		 <form id="fm" method="post">
			 <div class="frm-container">

				 <div class="frm-field">
					 <span class="frm-label">实收金额：</span>
					 <span class="frm-control">
						<input type="text" id="amount" name="amount" class="easyui-numberbox easyui-validatebox"
							   required="true" data-options="min:0,precision:2" />

						 <input type="hidden" id="saleId" name="saleId" />
					</span>
				 </div>
			 </div>
		 </form>
	 </fieldset>
 </div>

 <div id="dlg-buttons">
	 <a href="javascript:saveUserAmount()" class="easyui-linkbutton" iconCls="icon-ok" >保存</a>
	 <a href="javascript:closeUserAmountDialog()" class="easyui-linkbutton" iconCls="icon-cancel" >关闭</a>
 </div>

</body>
</html>