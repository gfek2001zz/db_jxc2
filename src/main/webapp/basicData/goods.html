<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>商品管理</title>
<link rel="stylesheet" type="text/css" href="/static/jquery-easyui-1.3.3/themes/default/easyui.css"></link>
<link rel="stylesheet" type="text/css" href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
<script type="text/javascript" src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
<script type="text/javascript" src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
<script type="text/javascript" src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="/static/js/Mtils.min.js"></script>
<script type="text/javascript">

	var url;

	$(document).ready(function() {

        $("#dg4").datagrid({
            onDblClickRow:function(index,row){
                var name=row.name;
                $("#unit").combobox("reload");
                $("#unit").combobox("setValue",name);
                $("#dlg4").dialog("close");
            }
        });

        $("#dg").datagrid({
            onDblClickRow:function(index,row){
                $("#dlg2").dialog("open").dialog("setTitle","修改商品信息");
                $("#fm2").form("load",row);
                $("#typeId").val(row.type.id);
                $("#typeName").val(row.type.name);
                url="/admin/goods/save?id="+row.id;
                $("#saveAddAddNextButton").hide();
            }
        });

		$("#tree").tree({
			lines:true,
			url:'/admin/goodsType/loadTreeInfo',
			onLoadSuccess:function(){
				$("#tree").tree("expandAll");
			},
			onClick:function(node){
				debugger;
			    if (node.text == '床垫') {
                    $("#chooseGoodsNameDialog").hide();
                    $("input#name").removeAttr("readonly");
				} else {
                    $("#chooseGoodsNameDialog").show();
                    $("input#name").attr("readonly", "readonly");
				}

				if(node.attributes.state==0){ // 假如是叶子节点，删除按钮恢复可用
					$("#del").linkbutton("enable");

                    $("#dg").datagrid('load',{
                        "name":$("#s_name").val(),
                        "type.id":node.id
                    });
				}else{
					$("#del").linkbutton("disable");
				}
			}
		});

	});

	function openGoodsTypeAddDialog(){
		$("#dlg").dialog("open").dialog("setTitle","新增商品类别");
	}

	function deleteGoodsType(){
		var node=$("#tree").tree("getSelected"); // 获取选中节点
		var id=node.id;
		$.post("/admin/goodsType/delete",{id:id},function(result){
			if(result.success){
				$("#tree").tree("reload");
				$("#del").linkbutton("disable");
			}else{
				$.messager.alert("系统提示",result.errorInfo);
			}
		},"json");
	}

	function saveGoodsType(){
		if(!$("#fm").form("validate")){
			return;
		}
		var goodsTypeName=$('#goodsTypeName').val();
		var node=$("#tree").tree("getSelected"); // 获取选中节点
		var parentId;
		if(node==null){
			parentId=1;
		}else{
			parentId=node.id;
		}
		$.post("/admin/goodsType/save",{name:goodsTypeName,parentId:parentId},function(result){
			if(result.success){
				$("#tree").tree("reload");
				closeGoodsTypeDialog();
			}else{
				$.messager.alert("系统提示","提交失败，请联系管理员！");
			}
		},"json");
	}

	function closeGoodsTypeDialog(){
		$("#dlg").dialog("close");
		$('#goodsTypeName').val('');
	}


	// 商品管理

	function formatGoodsTypeId(val,row){
		return row.type.id;
	}

	function formatGoodsTypeName(val,row){
		return row.type.name;
	}

	function formatPurchasingPrice(val,row){
		return "¥"+val;
	}

	function formatSellingPrice(val,row){
		return "¥"+val;
	}

	function searchGoods(){
		$("#dg").datagrid('load',{
			"name":$("#s_name").val()
		});
	}

	function openGoodsAddDialog(){
		var node=$("#tree").tree("getSelected");
		if(node!=null && node.id!=1){
			$("#typeId").val(node.id);
			$("#typeName").val(node.text);

            $("#dlg2").dialog("open").dialog("setTitle","添加商品信息");
            url="/admin/goods/save";


            $.post("/admin/goods/genGoodsCode",{},function(result){
                $("#code").val(result);
            });
            $("#saveAddAddNextButton").show();

		}else{
			$("#typeId").val("");
			$("#typeName").val("");
            $.messager.alert("系统提示","请先选择一个商品类别！");
            return false;

		}
	}

	function openChooseGoodsTypeDialog(){
		$("#dlg3").dialog("open").dialog("setTitle","选择商品类别");
		$("#typeTree").tree({
			url:'/admin/goodsType/loadTreeInfo',
			onLoadSuccess:function(){
				var rootNode=$("#typeTree").tree("getRoot");
				$("#typeTree").tree("expand",rootNode.target);
			}
		});
	}

	function resetValue(){
		$("#typeId").val("");
		$("#typeName").val("");
		$("#code").val("");
		$("#name").val("");
		$("#model").val("");
        $("#size").val("");
        $("#style").val("");
        $("#color").val("");
		$("#unit").combobox("setValue","");
		$("#purchasingPrice").numberbox("setValue","");
		$("#sellingPrice").numberbox("setValue","");
		$("#minNum").numberbox("setValue","");
		$("#producer").val("");
		$("#remarks").val("");
	}

	function saveGoodsTypeChoose(){
		var node=$("#typeTree").tree("getSelected");
		if(node!=null && node.id!=1){
			$("#typeId").val(node.id);
			$("#typeName").val(node.text);
		}
		$("#dlg3").dialog("close");
	}

	function closeGoodsTypeChooseDialog(){
		$("#dlg3").dialog("close");
	}

	function saveGoods(type){
		$("#fm2").form("submit",{
			url:url,
			onSubmit:function(){
				return $(this).form("validate");
			},
			success:function(result){
				var result=eval('('+result+')');
				if(result.success){
					$.messager.alert("系统提示","保存成功！");
					resetValue();
					if(type==1){
						$("#dlg2").dialog("close");
					}else if(type==2){
						var node=$("#tree").tree("getSelected");
						if(node!=null && node.id!=1){
							$("#typeId").val(node.id);
							$("#typeName").val(node.text);
						}else{
							$("#typeId").val("");
							$("#typeName").val("");
						}
						$.post("/admin/goods/genGoodsCode",{},function(result){
							$("#code").val(result);
						});
					}
					$("#dg").datagrid("reload");
				}else{
					$.messager.alert("系统提示",result.errorInfo);
				}
			}
		});
	}

	function closeGoodsDialog(){
		resetValue();
		$("#dlg2").dialog("close");
	}

	function openGoodsModifyDialog(){
		var selectedRows=$("#dg").datagrid("getSelections");
		if(selectedRows.length!=1){
			$.messager.alert("系统提示","请选择一条要修改的数据！");
			return;
		}
		var row=selectedRows[0];
		$("#dlg2").dialog("open").dialog("setTitle","修改商品信息");
		$("#fm2").form("load",row);
		$("#typeId").val(row.type.id);
		$("#typeName").val(row.type.name);
		url="/admin/goods/save?id="+row.id;
		$("#saveAddAddNextButton").hide();
	}

	function deleteGoods(){
		var selectedRows=$("#dg").datagrid("getSelections");
		if(selectedRows.length!=1){
			$.messager.alert("系统提示","请选择一条要删除的数据！");
			return;
		}
		var id=selectedRows[0].id;
		$.messager.confirm("系统提示","您确定要删除这条数据吗?",function(r){
			if(r){
				$.post("/admin/goods/delete",{id:id},function(result){
					if(result.success){
						$.messager.alert("系统提示","数据已成功删除！");
						$("#dg").datagrid("reload");
					}else{
						$.messager.alert("系统提示","<font color=red>"+result.errorInfo+"</font>");
					}
				},"json");
			}
		});
	}

	// 商品单位模块

	function openChooseGoodsUnitDialog(){
		$("#dlg4").dialog("open").dialog("setTitle","单位");
	}

	function openGoodsUnitAddDialog(){
		$("#dlg5").dialog("open").dialog("setTitle","添加单位信息");
		url="/admin/goodsUnit/save";
	}

	function deleteGoodsUnit(){
		var selectedRows=$("#dg4").datagrid("getSelections");
		if(selectedRows.length!=1){
			$.messager.alert("系统提示","请选择一条要删除的数据！");
			return;
		}
		var id=selectedRows[0].id;
		$.messager.confirm("系统提示","您确定要删除这条数据吗?",function(r){
			if(r){
				$.post("/admin/goodsUnit/delete",{id:id},function(result){
					if(result.success){
						$("#dg4").datagrid("reload");
						$("#unit").combobox("reload");
					}else{
						$.messager.alert("系统提示",result.errorInfo);
					}
				},"json");
			}
		});
	}

	function chooseGoodsUnit(){
		var selectedRows=$("#dg4").datagrid("getSelections");
		if(selectedRows.length!=1){
			$.messager.alert("系统提示","请选择单位！");
			return;
		}
		var name=selectedRows[0].name;
		$("#unit").combobox("reload");
		$("#unit").combobox("setValue",name);
		$("#dlg4").dialog("close");
	}

	function closeGoodsUnitDialog(){
		$("#dlg4").dialog("close");
	}

	function saveGoodsUnit(){
		$("#fm5").form("submit",{
			url:url,
			onSubmit:function(){
				return $(this).form("validate");
			},
			success:function(result){
				var result=eval('('+result+')');
				if(result.success){
					$.messager.alert("系统提示","保存成功！");
					closeGoodsUnitAddDialog();
					$("#unit").combobox("reload");
					$("#dg4").datagrid("reload");
				}else{
					$.messager.alert("系统提示",result.errorInfo);
				}
			}
		});
	}

	function closeGoodsUnitAddDialog(){
		$("#dlg5").dialog("close");
		$("#goodsUnitName").val("");
	}



	function openChooseGoodsNameDialog() {
        $("#dlg6").dialog("open").dialog("setTitle","选择品名");
        $("#dg6").datagrid('load',{
            "classifyCode": "BED_TYPE"
        });
        $("#chooseSave").unbind();
        $("#chooseSave").bind("click", function() {
            saveGoodsDictItem("name");
		})
	}

	function openChooseGoodsModeDialog() {
        var typeName = $("#typeName").val();
        if (typeName == "皮床") {
            if ($("#name").val() != "") {
                $("#dlg6").dialog("open").dialog("setTitle","选择商品型号");

                var classifyCode = "BED_" + Mtils.utils.makePy($("#name").val(), true).toUpperCase() + "_MODE";
                $("#dg6").datagrid('load',{
                    "classifyCode": classifyCode
                });
			} else {
                $.messager.alert("系统提示","请先选择品名！");
			}

		} else if (typeName == "床垫") {
        	$("#dlg6").dialog("open").dialog("setTitle","选择商品型号");
            $("#dg6").datagrid('load',{
                "classifyCode": "MATTRESS_MODE"
            });
		}

        $("#chooseSave").unbind();
        $("#chooseSave").bind("click", function() {
            saveGoodsDictItem("model");
        })
	}

	function openChooseGoodsSizeDialog() {
        $("#dlg6").dialog("open").dialog("setTitle","选择商品尺寸");
        $("#dg6").datagrid('load',{
            "classifyCode": "PRODUCT_SIZE"
        });

        $("#chooseSave").unbind();
        $("#chooseSave").bind("click", function() {
            saveGoodsDictItem("size");
        })
    }

    function openChooseGoodsBrandDialog() {
        $("#dlg6").dialog("open").dialog("setTitle","选择商品品牌");
        $("#dg6").datagrid('load',{
            "classifyCode": "PRODUCT_BRAND"
        });

        $("#chooseSave").unbind();
        $("#chooseSave").bind("click", function() {
            saveGoodsDictItem("brand");
        })
    }



	function saveGoodsDictItem(fieldId) {
        var selectedRows=$("#dg6").datagrid("getSelections");
        if(selectedRows.length!=1){
            $.messager.alert("系统提示","请选择一条数据！");
            return;
        }

        $("#" + fieldId).val(selectedRows[0].itemName);

        $("#dlg6").dialog("close");
    }

    function closeGoodsDictItemAddDialog() {

        $("#dlg6").dialog("close");
	}


	function exportGoods() {
	    window.location = "/admin/goods/export";
	}
</script>
</head>
<body class="easyui-layout" style="padding-top: 2px">
	<div data-options="region:'west',collapsible:false" style="width: 200px" title="商品类别" split=true>
		<ul id="tree" class="easyui-tree" style="padding: 10px"></ul>
		<div style="position: absolute;bottom: 10px;left: 15px">
			<a href="javascript:openGoodsTypeAddDialog()" class="easyui-linkbutton" iconCls="icon-add" >新增</a>
			<a id="del"  href="javascript:deleteGoodsType()" class="easyui-linkbutton" disabled=true iconCls="icon-remove">删除</a>
		</div>
	</div>
	<div data-options="region:'center'">
		<table id="dg" title="商品管理" class="easyui-datagrid"
			fitColumns="true" pagination="true" rownumbers="true" singleSelect="true"
			fit="true" toolbar="#tb" url="/admin/goods/list">
			<thead>
				<th field="id" width="30" align="center">编号</th>
				<th field="typeName" width="50" align="center" formatter="formatGoodsTypeName">类别</th>
				<th field="brand" width="50" align="center">品牌</th>
				<th field="code" width="50" align="center">商品编号</th>
				<th field="name" width="100" align="center">品名</th>
				<th field="model" width="50" align="center">型号</th>
				<th field="style" width="50" align="center">款式</th>
				<th field="size" width="50" align="center">尺寸</th>
				<th field="color" width="50" align="center">颜色</th>
				<th field="sellingPrice" width="50" align="center" formatter="formatPurchasingPrice">零售价</th>
				<th field="purchasingPrice" width="50" align="center" formatter="formatPurchasingPrice">采购价</th>
			</thead>
		</table>

			<div id="tb">
				<div>
					<a href="javascript:openGoodsAddDialog()" class="easyui-linkbutton" iconCls="icon-add" plain="true">添加</a>
					<a href="javascript:openGoodsModifyDialog()" class="easyui-linkbutton" iconCls="icon-edit" plain="true">修改</a>
					<a href="javascript:deleteGoods()" class="easyui-linkbutton" iconCls="icon-remove" plain="true">删除</a>
					<a href="javascript:exportGoods()" class="easyui-linkbutton" iconCls="icon-save" plain="true">导出</a>
				</div>
				<div>
					&nbsp;供应商名称：&nbsp;<input type="text" id="s_name" size="20" onkeydown="if(event.keyCode==13) searchGoods()"/>
					<a href="javascript:searchGoods()" class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
				</div>
			</div>
	</div>

	<div id="dlg" class="easyui-dialog" style="width: 300px;height: 120px;padding: 10px 20px"
	closed="true" buttons="#dlg-buttons" data-options="onClose:function(){$('#goodsTypeName').val('');}">
		<form id="fm" method="post">
			<div>
				商品类别：&nbsp;<input type="text" id="goodsTypeName" name="goodsTypeName" class="easyui-validatebox" required="true"/>
			</div>
		</form>
	</div>

	<div id="dlg-buttons">
		<a href="javascript:saveGoodsType()" class="easyui-linkbutton" iconCls="icon-ok" >保存</a>
		<a href="javascript:closeGoodsTypeDialog()" class="easyui-linkbutton" iconCls="icon-cancel" >关闭</a>
	</div>

	<div id="dlg2" class="easyui-dialog" style="width: 530px;height: 400px;padding: 10px 20px"
	closed="true" buttons="#dlg-buttons2" data-options="onClose:function(){resetValue()}">
		<form id="fm2" method="post">
			<table>
				<tr>
					<td>所属类别：</td>
					<td>
						<input type="hidden" id="typeId" name="type.id">
						<input type="text" id="typeName" class="easyui-validatebox" required="true" style="width: 90px" readonly="readonly" onclick="openChooseGoodsTypeDialog()"/>
						<a href="javascript:openChooseGoodsTypeDialog()" class="easyui-linkbutton" iconCls="icon-search" plain="true"></a>
					</td>
					<td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
					<td>商品编码：</td>
					<td>
						<input type="text" id="code" name="code" class="easyui-validatebox" required="true" style="width: 120px" readonly="readonly" />
					</td>
				</tr>
				<tr>
					<td>品牌：</td>
					<td>
						<input type="text" id="brand" name="brand" readonly="readonly" required="true" style="width: 120px"  />
						<a id="chooseGoodsBrandDialog" href="javascript:openChooseGoodsBrandDialog()" class="easyui-linkbutton" iconCls="icon-search" plain="true"></a>
					</td>
					<td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
					<td>品名：</td>
					<td>
						<input type="text" id="name" name="name" class="easyui-validatebox" readonly="readonly" required="true" style="width: 120px;"  />
						<a id="chooseGoodsNameDialog" href="javascript:openChooseGoodsNameDialog()" class="easyui-linkbutton" iconCls="icon-search" plain="true"></a>
					</td>
				</tr>
				<tr>
					<td>型号：</td>
					<td>
						<input type="text" id="model" name="model" style="width: 120px"  />
						<a href="javascript:openChooseGoodsModeDialog()" class="easyui-linkbutton" iconCls="icon-search" plain="true"></a>
					</td>
					<td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
					<td>款式：</td>
					<td>
						<input type="text" id="style" name="style" style="width: 120px"  />
					</td>
				</tr>
				<tr>
					<td>颜色：</td>
					<td>
						<input type="text" id="color" name="color" style="width: 120px"  />
					</td>
					<td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
					<td>尺寸：</td>
					<td>
						<input type="text" id="size" name="size" style="width: 120px"  />
						<a href="javascript:openChooseGoodsSizeDialog()" class="easyui-linkbutton" iconCls="icon-search" plain="true"></a>
					</td>
				</tr>
				<tr>
					<td>采购价：</td>
					<td>
						<input type="text" id="purchasingPrice" name="purchasingPrice" class="easyui-numberbox" data-options="min:0" required="true" style="width: 120px"  />
					</td>
					<td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
					<td>零售价：</td>
					<td>
						<input type="text" id="sellingPrice" name="sellingPrice" class="easyui-numberbox" data-options="min:0" required="true" style="width: 120px"  />
					</td>
				</tr>
				<tr>
					<td valign="top">备注：</td>
					<td colspan="4">
						<textarea rows="5" cols="46" id="remarks" name="remarks"></textarea>
					</td>
				</tr>
			</table>
		</form>
	</div>

	<div id="dlg-buttons2">
	    <a id="saveAddAddNextButton" href="javascript:saveGoods(2)" class="easyui-linkbutton" iconCls="icon-ok" >保存并新增下一商品</a>
		<a href="javascript:saveGoods(1)" class="easyui-linkbutton" iconCls="icon-ok" >保存</a>
		<a href="javascript:closeGoodsDialog()" class="easyui-linkbutton" iconCls="icon-cancel" >关闭</a>
	</div>

	<div id="dlg3" class="easyui-dialog" style="width: 180px;height: 300px;padding: 10px 10px"
	closed="true" buttons="#dlg-buttons3" >
		<ul id="typeTree" class="easyui-tree" ></ul>
	</div>

	<div id="dlg-buttons3">
		<a href="javascript:saveGoodsTypeChoose()" class="easyui-linkbutton" iconCls="icon-ok" plain="true">选择</a>
		<a href="javascript:closeGoodsTypeChooseDialog()" class="easyui-linkbutton" iconCls="icon-cancel" plain="true">关闭</a>
	</div>

	<div id="dlg4" class="easyui-dialog" style="width: 200px;height: 300px;"
	closed="true" >
		<table id="dg4"  class="easyui-datagrid"
			fitColumns="true"  rownumbers="true" singleSelect="true"
			url="/admin/goodsUnit/listAll" fit="true" toolbar="#tb4">
				<thead>
					<th field="id" width="100" align="center" hidden="true">编号ID</th>
					<th field="name" width="100" align="center">单位名称</th>
				</thead>
			</table>

			<div id="tb4">
				<div>
					<a href="javascript:openGoodsUnitAddDialog()" class="easyui-linkbutton"  plain="true">添加</a>
					<a href="javascript:deleteGoodsUnit()" class="easyui-linkbutton"  plain="true">删除</a>
					<a href="javascript:chooseGoodsUnit()" class="easyui-linkbutton"  plain="true">确定</a>
					<a href="javascript:closeGoodsUnitDialog()" class="easyui-linkbutton"  plain="true">取消</a>
				</div>
			</div>
	</div>

	<div id="dlg5" class="easyui-dialog" style="width: 300px;height: 120px;padding: 10px 20px"
	closed="true" buttons="#dlg-buttons5" data-options="onClose:function(){$('#goodsUnitName').val('');}">
		<form id="fm5" method="post">
			<div>
				商品单位：&nbsp;<input type="text" id="goodsUnitName" name="name" class="easyui-validatebox" required="true"/>
			</div>
		</form>
	</div>

	<div id="dlg-buttons5">
		<a href="javascript:saveGoodsUnit()" class="easyui-linkbutton" iconCls="icon-ok" >保存</a>
		<a href="javascript:closeGoodsUnitAddDialog()" class="easyui-linkbutton" iconCls="icon-cancel" >关闭</a>
	</div>


	<div id="dlg6" class="easyui-dialog" buttons="#dlg-buttons6" style="width: 400px;height: 300px;" closed="true">
		<table id="dg6" class="easyui-datagrid"
			   fitColumns="true"  rownumbers="true" singleSelect="true"
			   url="/admin/dict/item/list" fit="true">
			<thead>
				<th field="itemCode" width="100" align="center">编码</th>
				<th field="itemName" width="100" align="center">名称</th>
			</thead>
		</table>
	</div>

	<div id="dlg-buttons6">
		<a id="chooseSave" class="easyui-linkbutton" iconCls="icon-ok" >保存</a>
		<a href="javascript:closeGoodsDictItemAddDialog()" class="easyui-linkbutton" iconCls="icon-cancel" >关闭</a>
	</div>
</body>
</html>